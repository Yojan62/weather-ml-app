name: CD Pipeline

# Trigger this ONLY after the CI Pipeline successfully completes
on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Safety Check: Only run if CI actually passed.
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    # ---------------------------------------------------------------------
    # TASK 4(g): Deploy passed builds to Kubernetes without disrupting service.
    # ---------------------------------------------------------------------
    - name: SSH to Production Server and Deploy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PROD_SSH_HOST }}
        username: ${{ secrets.PROD_SSH_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        script: |
          echo "Logged into Production Server..."
          
          # Optional: Pull the latest Kubernetes manifests (deployment.yml/service.yml)
          # This ensures K8s has the latest configuration files
          cd weather-ml-app || echo "Folder not found, skipping git pull"
          git pull origin main || echo "Git pull failed, continuing..."

          # FORCE UPDATE: This command restarts the pods.
          # Since imagePullPolicy is 'Always', K8s will download the new 'latest' image that was just pushed.
          kubectl rollout restart deployment/weather-app-deployment
          
          # Verification: Wait until the update is finished
          kubectl rollout status deployment/weather-app-deployment
          
          echo "Deployment successfully completed."