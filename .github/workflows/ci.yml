name: CI Pipeline

# -------------------------------------------------------------------------
# TASK 4(a): Detect changes to your GitHub Repository.
# -------------------------------------------------------------------------
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-test-push:
    runs-on: ubuntu-latest

    steps:
    # Standard Setup: Check out the code from GitHub so the runner can see it.
    - name: Checkout Code
      uses: actions/checkout@v4

    # ---------------------------------------------------------------------
    # TASK 4(b): Install Flask and dependencies in requirements.txt.
    # ---------------------------------------------------------------------
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # ---------------------------------------------------------------------
    # TASK 4(c): Run the test files defined in Task 2.
    # ---------------------------------------------------------------------
    - name: Run Smoke Test
      run: python -m unittest tests/smoke_test.py

    - name: Run Unit Test
      # We use -W ignore to keep the logs clean (ignoring scikit-learn warnings)
      run: python -W ignore -m unittest tests/unit_test.py

    - name: Run Integration Test
      run: python -m unittest tests/integration_test.py

    # ---------------------------------------------------------------------
    # TASK 4(d): Build a Docker Image from your Dockerfile.
    # ---------------------------------------------------------------------
    - name: Build Docker Image
      run: |
        # Builds the image and tags it with the specific commit hash (github.sha)
        docker build -t ${{ secrets.DOCKER_USERNAME }}/weather-app:${{ github.sha }} .

    # ---------------------------------------------------------------------
    # TASK 4(e): Test that a Container can be launched (Build Test).
    # ---------------------------------------------------------------------
    - name: Test Container Launch
      run: |
        # 1. Run the container in the background (-d)
        docker run -d --name test-container -p 5000:5000 ${{ secrets.DOCKER_USERNAME }}/weather-app:${{ github.sha }}
        
        # 2. Wait a few seconds for Flask to start up
        sleep 10
        
        # 3. 'curl' the app. If it returns 200 OK, the container is alive.
        curl --fail http://localhost:5000/ || exit 1
        
        # 4. cleanup
        docker stop test-container

    # ---------------------------------------------------------------------
    # TASK 4(f): Push the Image to DockerHub.
    # ---------------------------------------------------------------------
    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Push Image to DockerHub
      run: |
        # Push the specific version (good for rollback)
        docker push ${{ secrets.DOCKER_USERNAME }}/weather-app:${{ github.sha }}
        
        # Tag and push 'latest' so Kubernetes always knows what to pull
        docker tag ${{ secrets.DOCKER_USERNAME }}/weather-app:${{ github.sha }} ${{ secrets.DOCKER_USERNAME }}/weather-app:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/weather-app:latest